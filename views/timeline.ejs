<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <link
    rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css"
  />
  <link
    rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css"
  />
</head>

<script type="application/javascript">
  $(document).ready(function () {
    $.ajax({
      type: "GET",
      url: "/api/post/timeline/user/<%= userId%>",
      dataType: "json",
      headers: {
        Authorization: "Bearer " + "<%=accesstoken%>",
      },
      success: function (data) {
        if (data) {
          data.map((post) => {
            populateTimeLine(post);
          });
        }
      },
    });
  });

  const posttemplate = `
    <li id="{postIdentifier}" class="list-group-item">
        <div class="media-body">
            <small class="text-muted pull-right">{createdtime}</small>
            <h4 class="media-heading">@{name}</h4>
            <div>
            {description}
            </div>
        </div>

        </li>
`;

  function populateTimeLine(data) {
    let populatedtemplate = posttemplate
      .replace("{createdtime}", data.createdAt)
      .replace("{name}", data.username)
      .replace("{description}", data.description);
    $("#posts").prepend(populatedtemplate);
  }

  function createpost() {
    var formData = {
      userId: "<%= userId %>",
      description: $("#description").val(),
    };
    $.ajax({
      type: "POST",
      url: "/api/post",
      data: formData,
      dataType: "json",
      headers: {
        Authorization: "Bearer " + "<%=accesstoken%>",
      },
    });

    $("#description").val("");
    event.preventDefault();
  }

  let socket = io("http://localhost:3013");
  socket.emit("newsfeed", "<%= userId %>");
  //socket.emit("userConnected",)
  socket.on("post", (data) => {
    let populatedtemplate = posttemplate
      .replace("{createdtime}", data.createdAt)
      .replace("{name}", data.username)
      .replace("{description}", data.description);
    $("#posts").prepend(populatedtemplate);
  });
</script>

<div class="row">
  <div class="col-md-6 col-xs-12 col-md-offset-3">
    <div class="panel">
      <div class="panel-heading">
        <h3 class="panel-title">Welcome <%= username %></h3>
      </div>

      <div class="panel-body">
        <div class="form-group">
          <textarea
            id="description"
            name="description"
            class="form-control"
            placeholder="Enter here ..."
            rows="3"
          ></textarea>
        </div>
        <button
          onclick="createpost()"
          class="btn btn-info btn-sm pull-right waves-effect waves-light"
        >
          Post
        </button>

        <div class="clearfix"></div>
        <hr class="margin-bottom-10" />

        <ul
          id="posts"
          class="list-group list-group-dividered list-group-full"
        ></ul>
      </div>
    </div>
  </div>
</div>
